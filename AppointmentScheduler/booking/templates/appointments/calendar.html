{% extends 'base.html' %}
{% block content %}
<h2>Appointments Calendar</h2>

<div id='calendar'></div>

<!-- Modal for Add/Edit Appointment -->
<div id="appointmentModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span id="closeModal" class="close">&times;</span>
    <h3 id="modalTitle">Add Appointment</h3>
    <form id="appointmentForm" method="post">
      {% csrf_token %}
      <div id="formFields">
        <!-- Form fields will be loaded here via AJAX -->
      </div>
      <button type="submit" class="btn">Save</button>
    </form>
  </div>
</div>

<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/main.min.js'></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var modal = document.getElementById('appointmentModal');
    var closeModal = document.getElementById('closeModal');
    var form = document.getElementById('appointmentForm');
    var formFields = document.getElementById('formFields');
    var modalTitle = document.getElementById('modalTitle');

    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 650,
        events: "{% url 'calendar_events' %}",
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        dateClick: function(info) {
            // Open modal for new appointment on clicked date
            modalTitle.textContent = 'Add Appointment';
            loadForm("{% url 'appointment_add' %}?date=" + info.dateStr);
            modal.style.display = 'block';
        },
        eventClick: function(info) {
            // Open modal for editing appointment
            modalTitle.textContent = 'Edit Appointment';
            loadForm(info.event.url);
            info.jsEvent.preventDefault();
            modal.style.display = 'block';
        }
    });

    calendar.render();

    closeModal.onclick = function() {
        modal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }

    // Load form via AJAX
    function loadForm(url) {
        fetch(url)
        .then(response => response.text())
        .then(html => {
            formFields.innerHTML = html;
            form.action = url;
        });
    }

    // Submit form via AJAX
    form.addEventListener('submit', function(e){
        e.preventDefault();
        const data = new FormData(form);
        fetch(form.action, {
            method: 'POST',
            body: data
        })
        .then(response => {
            if(response.redirected){
                calendar.refetchEvents();
                modal.style.display = 'none';
            }
            return response.text();
        })
        .then(html => {
            formFields.innerHTML = html; // show validation errors if any
        });
    });
});
</script>

<style>
/* Modal Styling */
.modal {
  position: fixed;
  z-index: 100;
  left: 0; top: 0;
  width: 100%; height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.5);
}
.modal-content {
  background-color: #fff;
  margin: 10% auto;
  padding: 20px;
  border-radius: 8px;
  width: 400px;
  position: relative;
}
.close {
  position: absolute;
  top: 10px; right: 15px;
  font-size: 25px;
  cursor: pointer;
}
</style>

{% endblock %}
